  *{box-sizing:border-box;}
  html,body{margin:0;width:100%;height:100%;overflow:hidden;background:#181818;font-family:sans-serif;}
  :root{--ui-bg:#000a;--ui-fg:#eee;--zone-border:#00bfff88;--zone-fill:#00bfff14;--card-w:180px; --set-thumb-w:clamp(130px,18vw,220px); --set-thumb-aspect:21/11;}
  #board{position:relative;width:100vw;height:100vh;background:#222;overflow:hidden;}
  #board::before{content:"";position:absolute;inset:0;background:url("playmat.png") center/cover no-repeat;z-index:0;transform:rotate(0deg);transform-origin:center;pointer-events:none;}
  body.flipLayout #board::before{transform:rotate(180deg);}
  .zone,.card{z-index:2;}

  #toolbar{position:fixed;top:8px;left:8px;z-index:12000;background:var(--ui-bg);max-width:calc(100vw - 16px);flex-wrap:wrap;color:var(--ui-fg);padding:6px 10px;border-radius:6px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;font-size:13px;backdrop-filter:blur(4px);}    
  #toolbar button,#toolbar label{cursor:pointer;border:none;background:#333;color:#fff;padding:4px 8px;border-radius:4px;font-size:12px;}#toolbar button:hover,#toolbar label:hover{background:#555;}
  #toolbar select{background:#111;color:#fff;border:1px solid #555;border-radius:4px;padding:2px 4px;}
  #fileInput,#backInput{display:none;}
  .zone{position:absolute;border:2px dashed var(--zone-border);background:var(--zone-fill);color:#bdeaff;font-size:12px;padding:2px 4px;pointer-events:none;}
  .zone-label{position:absolute;top:-16px;left:0;font-weight:bold;text-shadow:0 0 3px #000;}
  .zoneUI{position:absolute;right:4px;bottom:4px;display:flex;gap:4px;pointer-events:auto;}
  .zoneUI button{background:#000c;color:#fff;border:1px solid #555;font-size:11px;padding:2px 6px;border-radius:4px;cursor:pointer;}
  .areaUI{position:absolute;top:-20px;left:50%;transform:translateX(-50%);display:flex;gap:4px;pointer-events:auto;}
  .areaUI button{background:#000c;color:#fff;border:1px solid #555;font-size:10px;padding:1px 4px;border-radius:4px;cursor:pointer;}
  /* flipLayout(上側盤面)では slot1~5 のエリアボタンが手札に被るため、下側へ移動 */
  body.flipLayout .zone[data-zone-id="slot1"] .areaUI,
  body.flipLayout .zone[data-zone-id="slot2"] .areaUI,
  body.flipLayout .zone[data-zone-id="slot3"] .areaUI,
  body.flipLayout .zone[data-zone-id="slot4"] .areaUI,
  body.flipLayout .zone[data-zone-id="slot5"] .areaUI{
    top: calc(100% + 6px);
    bottom: auto;
  }
  .rageUI{position:absolute;inset:0;pointer-events:auto;display:flex;flex-direction:column;justify-content:center;align-items:center;gap:8px;}
  #rageCounter{background:#000c;color:#fff;border:2px solid #555;font-size:42px;font-weight:700;padding:6px 14px;border-radius:10px;min-width:72px;text-align:center;text-shadow:0 0 6px #000;}
  .rageBtns{display:flex;gap:6px;}
  .rageBtns button{background:#000c;color:#fff;border:1px solid #555;font-size:12px;padding:3px 10px;border-radius:4px;cursor:pointer;}
  .card{position:absolute;width:var(--card-w);height:auto;transform-origin:50% 50%;user-select:none;touch-action:none;border-radius:6px;box-shadow:0 2px 4px #000a;transition:box-shadow .12s ease;}
  .card.active{box-shadow:0 0 10px #00bfff;}
  .card.selected{outline:3px solid #ff0;}
  .hidden{display:none !important;}
  #deckCounter,#discardCounter,#monsterCounter{position:absolute;z-index:2100;color:#fff;font-size:18px;font-weight:bold;text-shadow:0 0 6px #000;background:#0007;padding:2px 6px;border-radius:4px;pointer-events:none;}
  /* viewer */
  #viewer.hidden{display:none;}#viewer{position:fixed;inset:0;z-index:4000;background:rgba(0,0,0,.82);display:flex;align-items:center;justify-content:center;}
  #viewerPanel{position:relative;width:80vw;height:80vh;background:#222;color:#eee;border-radius:10px;box-shadow:0 0 20px #000;padding:12px 16px;display:flex;flex-direction:column;}
  #viewerPanel h2{margin:0 0 8px;font-size:18px;}#viewerSearch{margin-bottom:8px;padding:4px 6px;width:220px;background:#111;color:#eee;border:1px solid #444;border-radius:4px;font-size:13px;}
  #viewerGrid{flex:1;overflow:auto;display:flex;flex-wrap:wrap;gap:6px;padding:4px;}
  .thumbWrap{position:relative;cursor:pointer;}
  .thumbWrap img{width:100px;border-radius:6px;box-shadow:0 2px 4px #000a;border:2px solid transparent;}
  .thumbWrap.selected img{border-color:#ff0;}
  .thumbName{position:absolute;bottom:2px;right:4px;background:#000a;color:#fff;font-size:11px;padding:1px 4px;border-radius:3px;}
  #viewerBtns{display:flex;gap:8px;justify-content:flex-end;margin-top:8px;}#viewerBtns button{background:#444;border:none;color:#fff;padding:6px 12px;border-radius:5px;font-size:13px;cursor:pointer;}#viewerBtns button:hover{background:#666;}
  /* start modal */
  #startModal{position:fixed;inset:0;z-index:4500;background:rgba(0,0,0,.85);display:flex;align-items:center;justify-content:center;}
  #startBox{background:#222;color:#eee;padding:24px 32px;border-radius:12px;box-shadow:0 0 20px #000;min-width:320px;text-align:center;}
  #startBox h1{margin:0 0 16px;font-size:22px;}
  #startBox button{margin:6px 0;padding:10px 16px;font-size:15px;background:#444;border:1px solid #666;border-radius:6px;color:#fff;cursor:pointer;width:100%;}
  #startBox button:hover{background:#666;}
  /* deck builder */
  #builder.hidden{display:none;}#builder{position:fixed;inset:0;z-index:4600;background:rgba(0,0,0,.88);display:flex;align-items:center;justify-content:center;}
  #builderPanel{position:relative;width:92vw;height:92vh;background:#222;color:#eee;border-radius:10px;box-shadow:0 0 20px #000;padding:12px 16px;display:flex;flex-direction:column;}
  #builderMain{flex:1;display:flex;gap:12px;overflow:hidden;}
  #mobileBuilderTabs{display:none;}
  #libPane{flex:1.2;display:flex;flex-direction:column;min-width:0;}
  #deckPane{flex:1;display:flex;flex-direction:column;min-width:0;overflow:hidden;}
  #libFilter{padding:10px 12px;width:100%;background:#111;color:#eee;border:1px solid rgba(255,255,255,18);border-radius:14px;font-size:13px;margin-bottom:8px;}

  #libMetaBar{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin:0 0 8px 0;
  }
  #libMetaBar select{
    background:#111;
    color:#eee;
    border:1px solid rgba(255,255,255,18);
    border-radius:12px;
    padding:8px 10px;
    font-size:12px;
    cursor:pointer;
  }
  
  /* set / pack filter (deck builder) */
  #libSetBar{
    display:flex;
    gap:10px;
    flex-wrap:nowrap;
    align-items:stretch;
    overflow-x:auto;
    padding:2px 2px 10px;
    margin:0 0 10px 0;
    scroll-snap-type:x proximity;
  }
  #libSetBar::-webkit-scrollbar{height:10px;}
  #libSetBar::-webkit-scrollbar-thumb{background:rgba(255,255,255,.18);border-radius:999px;}
  #libSetBar::-webkit-scrollbar-track{background:rgba(0,0,0,.25);border-radius:999px;}

  /* collapsible wrapper for set bar */
  .setSection{
    border:1px solid rgba(255,255,255,.12);
    background:rgba(0,0,0,.18);
    border-radius:12px;
    padding:8px 10px;
    margin:0 0 10px 0;
  }
  .setHeader{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    cursor:pointer;
    user-select:none;
    padding:2px 2px;
  }
  .setHeader:focus{outline:2px solid rgba(0,191,255,.65);outline-offset:2px;border-radius:10px;}
  .setHeaderLeft{display:flex;align-items:baseline;gap:8px;min-width:0;}
  .setHeaderTitle{font-size:12px;opacity:.9;letter-spacing:.06em;white-space:nowrap;}
  .setHeaderCurrent{
    font-size:12px;
    opacity:.95;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.16);
    background:rgba(0,0,0,.25);
    max-width:220px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
  }
  .setToggle{
    width:30px;height:30px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.18);
    background:rgba(0,0,0,.15);
    color:#fff;
    cursor:pointer;
    display:grid;
    place-items:center;
    padding:0;
    transition:transform .15s ease;
  }
  #libSetBarWrap{
    margin-top:8px;
    overflow:hidden;
    max-height:600px;
    opacity:1;
    transition:max-height .18s ease, opacity .18s ease, margin .18s ease;
  }
  .setSection.collapsed #libSetBarWrap{
    max-height:0;
    opacity:0;
    margin-top:0;
  }
  .setSection.collapsed .setToggle{transform:rotate(-90deg);}

  #libSetBar .setBtn{
    cursor:pointer;
    border:1px solid rgba(255,255,255,.14);
    background: rgba(0,0,0,.35);
    color:#fff;
    border-radius:16px;
    padding:10px 10px 8px;
    font-size:12px;
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:flex-start;
    gap:8px;
    min-width: calc(var(--set-thumb-w) + 20px);
    box-shadow: 0 10px 22px rgba(0,0,0,.32);
    scroll-snap-align:start;
    transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
  }
  #libSetBar .setBtn:hover{ filter:brightness(1.08); transform: translateY(-1px); }
  #libSetBar .setBtn:active{ transform: translateY(0) scale(.99); }
  #libSetBar .setBtn.active{
    outline:3px solid rgba(45,212,255,.72);
    outline-offset:1px;
    box-shadow: 0 0 0 1px rgba(45,212,255,.22), 0 14px 30px rgba(0,0,0,.38);
  }
  #libSetBar .setBtn img{
    width: var(--set-thumb-w);
    aspect-ratio: 21 / 11;
    height: auto;
    border-radius: 12px;
    display:block;
    border:1px solid rgba(255,255,255,.10);
  }
  #libSetBar .setBtn .setLabel{
    font-weight:800;
    letter-spacing:.02em;
    user-select:none;
    white-space:nowrap;
    line-height:1.05;
    opacity:.92;
  }
  #libSetBar .setBtn.all{
    min-width: 110px;
    padding:10px 12px;
    justify-content:center;
  }

#libList{flex:1;overflow:auto;display:flex;flex-wrap:wrap;gap:8px;padding:4px;background:#1113;border:1px solid #444;border-radius:4px;}
  .libCard{width:120px;cursor:pointer;position:relative;}
  .libCard img{width:100%;border-radius:6px;box-shadow:0 2px 4px #000a;}
  .libBtns{position:absolute;bottom:4px;left:4px;display:flex;gap:4px;}
  .libBtns button{background:#000b;color:#fff;border:1px solid #666;font-size:11px;padding:2px 4px;border-radius:4px;cursor:pointer;}
  #deckScroll{flex:1;overflow:auto;border:1px solid #444;border-radius:4px;padding:6px;background:#1113;display:flex;flex-direction:column;gap:12px;}
  .deckGroup{border:1px solid #444;border-radius:6px;padding:6px;background:#0004;}
  .deckGroup h4{margin:0 0 6px;font-size:15px;}
  .deckGrid{display:flex;flex-wrap:wrap;gap:6px;}
  .deckThumb{position:relative;width:90px;}
  .deckThumb img{width:100%;border-radius:6px;box-shadow:0 2px 4px #000a;}
  .deckCnt{position:absolute;top:2px;left:2px;background:#000c;color:#fff;font-size:11px;padding:1px 4px;border-radius:3px;}
  .deckThumb .ctrl{position:absolute;bottom:2px;right:2px;display:flex;gap:2px;}
  .deckThumb .ctrl button{background:#000b;color:#fff;border:1px solid #666;font-size:10px;padding:0 4px;border-radius:3px;cursor:pointer;}
  #builderFooter{margin-top:10px;border:1px solid rgba(255,255,255,.12);border-radius:12px;background:rgba(0,0,0,.18);padding:8px 10px;}
  .builderFooterHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;cursor:pointer;user-select:none;padding:2px 2px;}
  .builderFooterHeader:focus{outline:2px solid rgba(0,191,255,.65);outline-offset:2px;border-radius:10px;}
  .builderFooterToggle{width:30px;height:30px;border-radius:999px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.15);color:#fff;cursor:pointer;display:grid;place-items:center;padding:0;transition:transform .15s ease;}
  #builderFooterBody{margin-top:8px;display:flex;justify-content:flex-start;align-items:flex-start;gap:10px;flex-wrap:wrap;overflow:hidden;max-height:600px;opacity:1;transition:max-height .18s ease, opacity .18s ease, margin .18s ease;}
  #builderFooter textarea{flex:1 1 320px;width:auto;min-width:260px;height:54px;background:#000;color:#eee;border:1px solid #555;border-radius:4px;padding:4px;font-size:11px;}
  #builderFooter button{background:#444;border:1px solid #666;color:#fff;border-radius:6px;padding:6px 12px;cursor:pointer;}
  #builderFooter button:hover{background:#666;}
  .builderFooterSection.collapsed #builderFooterBody{max-height:0;opacity:0;margin-top:0;}
  .builderFooterSection.collapsed .builderFooterToggle{transform:rotate(-90deg);}

  .builderBtnCol{display:flex;flex-direction:row;flex-wrap:wrap;gap:6px;min-width:240px;flex:1 1 340px;justify-content:flex-end;align-items:center;}
  .builderBtnCol button,.builderBtnCol .btnLike{white-space:nowrap;}
  .builderSep{flex-basis:100%;width:100%;height:1px;background:rgba(255,255,255,.12);margin:6px 0;}
  .btnLike{display:inline-flex;align-items:center;justify-content:center;gap:6px;background:#444;border:1px solid #666;color:#fff;border-radius:6px;padding:6px 12px;cursor:pointer;user-select:none;}
  .btnLike:hover{background:#666;}
  .btnLike input{display:none;}

  /* deck manager */
  #deckMgr.hidden{display:none;}
  #deckMgr{position:fixed;inset:0;z-index:5200;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:16px;}
  #deckMgrPanel{width:min(920px,92vw);height:min(620px,86vh);background:#111;border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);display:flex;flex-direction:column;overflow:hidden;}
  #deckMgrHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);}
  #deckMgrHeader h2{margin:0;font-size:18px;}
  .deckMgrRight{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
  #deckMgrHeader input{width:min(320px,60vw);background:#000;border:1px solid #555;color:#fff;border-radius:10px;padding:8px 10px;font-size:13px;}
  #deckMgrList{padding:12px 14px;overflow:auto;display:flex;flex-direction:column;gap:10px;}
  .deckItem{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:12px;}
  .deckMeta{display:flex;flex-direction:column;gap:4px;min-width:0;}
  .deckName{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .deckInfo{opacity:.8;font-size:12px;}
  .deckActions{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
  .deckActions button{background:#444;border:1px solid #666;color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px;}
  .deckActions button:hover{background:#666;}
  #deckMgrFooter{padding:10px 14px;border-top:1px solid rgba(255,255,255,.10);display:flex;gap:8px;justify-content:flex-end;align-items:center;flex-wrap:wrap;}
  #deckMgrFooter .hint{margin-right:auto;opacity:.75;font-size:12px;}
  #countInfo{font-size:13px;}
    /* preview */
  #preview.hidden{display:none;}
  #preview{position:fixed;inset:0;z-index:5000;background:rgba(0,0,0,0.90);display:flex;align-items:center;justify-content:center;padding:16px;}
  #previewPanel{
    position:relative;
    width:min(96vw, 1200px);
    height:min(92vh, 760px);
    display:flex;
    gap:14px;
    align-items:stretch;
    justify-content:center;
  }
  #previewLeft{
    height:100%;
    aspect-ratio:460/642;
    max-width:62%;
    display:flex;
    align-items:center;
    justify-content:center;
  }
  #previewImg{
    width:100%;
    height:100%;
    object-fit:contain;
    border-radius:16px;
    box-shadow:0 0 20px #000;
    background:transparent;
  }
  #previewInfo{
    flex:1;
    min-width:240px;
    height:100%;
    overflow:auto;
    border-radius:16px;
    border:1px solid rgba(255,255,255,12);
    background:rgba(0,0,0,0.25);
    padding:12px 14px;
    color:#eee;
  }
  #previewInfo .pvTitle{font-size:24px;font-weight:900;margin:0 0 10px 0;}
  #previewInfo .pvSub{font-size:16px;opacity:.86;margin:0 0 16px 0;line-height:1.45;}
  #previewInfo .pvRow{margin:10px 0;font-size:17px;line-height:1.55;}
  #previewInfo .pvKey{opacity:.78;margin-right:6px;font-weight:800;}
#previewInfo .pvRowMeta{display:flex;flex-wrap:wrap;gap:14px 18px;}
#previewInfo .pvItem{display:inline-flex;align-items:center;gap:6px;min-width:0;}
#previewInfo .pvVal{display:inline-flex;align-items:center;gap:4px;min-width:0;}
  #previewInfo .pvTags{display:flex;gap:6px;flex-wrap:wrap;margin-top:8px;}
  #previewInfo .pvTag{font-size:16px;padding:5px 12px;border-radius:999px;border:1px solid rgba(255,255,255,20);background:rgba(255,255,255,0.90);color:#111;}
  #previewInfo .pvText{white-space:pre-wrap;font-size:17px;line-height:1.68;margin-top:12px;padding-top:12px;border-top:1px dashed rgba(255,255,255,14);}
  #previewClose{
    position:absolute;
    top:10px;right:10px;
    background:#000c;color:#fff;border:1px solid rgba(255,255,255,24);
    border-radius:999px;width:36px;height:36px;cursor:pointer;font-size:18px;
    display:grid;place-items:center;
  }

  /* preview: avoid toolbar overlap (normal play mode) */
  :root{ --previewSafeTop: 72px; }
  body:not(.soloActive) #preview{
    align-items:flex-start;
    justify-content:center;
    padding:16px;
    padding-top: calc(16px + var(--previewSafeTop));
  }
  body:not(.soloActive) #previewPanel{
    height: min(calc(92vh - var(--previewSafeTop)), 760px);
  }
/* token selector */
  #token.hidden{display:none;}#token{position:fixed;inset:0;z-index:4700;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;}
  #tokenPanel{position:relative;width:820px;max-width:95vw;max-height:90vh;background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:16px 18px;display:flex;flex-direction:column;gap:10px;}
  #tokenPanel h2{margin:0 0 8px;font-size:20px;}
  #tokenGrid{display:flex;gap:12px;flex-wrap:wrap;overflow:auto;padding:4px;}
  .tokenThumb{position:relative;cursor:pointer;}
  .tokenThumb img{width:140px;border-radius:8px;box-shadow:0 2px 6px #000a;border:3px solid transparent;}
  .tokenName{position:absolute;bottom:4px;right:6px;background:#000a;color:#fff;font-size:12px;padding:2px 6px;border-radius:4px;}
  .tokenThumb.selected img{border-color:#ff0;}
  #tokenFooter{display:flex;gap:10px;justify-content:flex-end;align-items:center;}
  #tokenCount{width:100px;background:#111;color:#eee;border:1px solid #444;border-radius:6px;padding:6px 8px;font-size:14px;}

  /* stack (area overlap) */
  
  /* ===== counter selector ===== */
  #counter.hidden{display:none;}
  #counter{position:fixed;inset:0;z-index:12650;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;}
  #counterPanel{position:relative;width:720px;max-width:94vw;max-height:88vh;overflow:hidden;background:#141414;border:1px solid rgba(255,255,255,.12);border-radius:18px;box-shadow:0 18px 60px rgba(0,0,0,.55);padding:16px 18px;display:flex;flex-direction:column;gap:10px;}
  #counterPanel h2{margin:0 0 2px;font-size:20px;}
  #counterHelp{font-size:13px;opacity:.86;line-height:1.35;}
  #counterGrid{display:flex;gap:12px;flex-wrap:wrap;overflow:auto;padding:6px 4px;}
  .counterThumb{position:relative;cursor:pointer;}
  .counterThumb img{height:44px;max-width:240px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.55);border:2px solid transparent;background:#000;}
  .counterThumb:hover img{border-color:#fff8;}
  #counterFooter{display:flex;align-items:center;justify-content:flex-end;gap:10px;padding-top:6px;}
  #counterFooter button{background:#333;border:1px solid #555;color:#fff;border-radius:12px;padding:8px 12px;cursor:pointer;}
  #counterFooter button:hover{background:#555;}
  #btnCounterClear{background:#8b0000;border-color:#b44;}
  #btnCounterClear:hover{background:#b00000;}

  /* ===== card counter overlay ===== */
  .cardCounterOverlay{
    position:absolute;
    left:0;
    top:0;
    width:var(--card-w);
    height:var(--card-h);
    pointer-events:none;
    transform-origin:50% 50%;
    z-index:3;
  }
  .cardCounterOverlay.hidden{display:none !important;}
  .cardCounterBadge{
    position:absolute;
    left:50%;
    bottom:6px;
    transform:translateX(-50%);
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    justify-content:center;
    gap:6px;
    row-gap:6px;
    max-width:calc(var(--card-w) - 12px);
  }
  .cardCounterBadge .ctrItem{
    display:flex;
    align-items:center;
    gap:4px;
  }
  .cardCounterBadge img{
    height:calc(2.1em * var(--ctr-scale, 1));
    vertical-align:middle;
    image-rendering:auto;
    filter:drop-shadow(0 2px 4px rgba(0,0,0,.55));
  }
  .cardCounterBadge .ctrCount{
    font-size:1.18em;
    font-weight:900;
    color:#fff;
    text-shadow:0 2px 4px rgba(0,0,0,.75);
    padding:1px 6px;
    border-radius:999px;
    background:rgba(0,0,0,.45);
    line-height:1.2;
  }


#stack.hidden{display:none;}
  #stack{position:fixed;inset:0;z-index:4750;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;}
  #stackPanel{position:relative;width:760px;max-width:95vw;max-height:88vh;background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:14px 16px;display:flex;flex-direction:column;gap:10px;}
  #stackPanel h2{margin:0;font-size:18px;}
  #stackHelp{font-size:12px;opacity:.85;}
  #stackList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:2px;}
  .stackRow{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#111;border:1px solid #333;border-radius:10px;cursor:pointer;}
  .stackRow.selected{outline:2px solid #ff0;}
  .stackThumb{position:relative;}
  .stackThumb img{width:90px;border-radius:8px;box-shadow:0 2px 6px #000a;}
  .stackBadge{position:absolute;top:6px;left:6px;background:#000a;color:#fff;font-size:11px;padding:1px 6px;border-radius:999px;}
  .stackInfo{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px;}
  .stackName{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .stackMeta{font-size:11px;opacity:.75;}
  .stackCtrl{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
  .stackCtrl button{background:#444;border:none;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;}
  .stackCtrl button:hover{background:#666;}
  #stackFooter{display:flex;gap:8px;justify-content:flex-end;}
  #stackFooter button{background:#444;border:none;color:#fff;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer;}
  #stackFooter button:hover{background:#666;}
  #stackDropChooser.hidden{display:none;}
  #stackDropChooser{position:fixed;inset:0;z-index:4760;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;}
  #stackDropChooserPanel{width:min(420px,92vw);background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:14px;display:flex;flex-direction:column;gap:10px;}
  #stackDropChooserTitle{font-size:16px;font-weight:700;}
  #stackDropChooserHelp{font-size:12px;opacity:.85;}
  #stackDropChooserBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
  #stackDropChooserBtns button{background:#444;border:none;color:#fff;padding:8px 12px;border-radius:8px;font-size:13px;cursor:pointer;}
  #stackDropChooserBtns button:hover{background:#666;}
  /* reveal (deck top 공개) */
  #reveal.hidden{display:none;}
  #reveal{position:fixed;inset:0;z-index:4800;background:rgba(0,0,0,.86);display:flex;align-items:center;justify-content:center;}
  #revealPanel{position:relative;width:760px;max-width:95vw;max-height:88vh;background:#222;color:#eee;border-radius:12px;box-shadow:0 0 20px #000;padding:14px 16px;display:flex;flex-direction:column;gap:10px;}
  #revealPanel h2{margin:0;font-size:18px;}
  #revealHelp{font-size:12px;opacity:.85;}
  #revealList{flex:1;overflow:auto;display:flex;flex-direction:column;gap:8px;padding:2px;}
  .revealRow{display:flex;align-items:center;gap:10px;padding:8px 10px;background:#111;border:1px solid #333;border-radius:10px;cursor:pointer;}
  .revealRow.selected{outline:2px solid #ff0;}
  .revealThumb img{width:90px;border-radius:8px;box-shadow:0 2px 6px #000a;}
  .revealInfo{flex:1;min-width:0;display:flex;flex-direction:column;gap:4px;}
  .revealName{font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .revealMeta{font-size:11px;opacity:.75;}
  .revealCtrl{display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end;}
  .revealCtrl button{background:#444;border:none;color:#fff;padding:6px 10px;border-radius:8px;font-size:12px;cursor:pointer;}
  .revealCtrl button:hover{background:#666;}
  #revealFooter{display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap;}
  #revealFooter button{background:#444;border:none;color:#fff;padding:8px 14px;border-radius:8px;font-size:13px;cursor:pointer;}
  #revealFooter button:hover{background:#666;}



  /* ===== Action Log ===== */
  /* ===== Spectator (Discord共有) ===== */
  #spectatorBadge{
    position:fixed; top:8px; right:8px; z-index:9999;
    background:#000c; color:#fff; padding:6px 10px; border-radius:10px;
    font-size:13px; display:none; user-select:none;
    white-space:pre-line;
  }
  body.spectator #spectatorBadge{ display:block; }
  body.spectator #toolbar{ display:none !important; }
  body.spectator #viewer{ display:none; } /* 山札サーチ一覧は非表示（共有画面には出さない） */
  body.spectator.showDiscardViewer #viewer{ display:flex; } /* 捨て札一覧は共有OK */
  body.spectator.showDiscardViewer #viewerSearch{ display:none !important; }
  body.spectator.showDiscardViewer #viewerBtns{ display:none !important; }

  #spectatorPickPanel{
    position:fixed; top:8px; left:8px; z-index:9999;
    background:#000c; color:#fff; padding:8px 10px; border-radius:12px;
    display:flex; align-items:center; gap:10px; user-select:none;
    max-width:420px;
  }
  #spectatorPickPanel img{ width:140px; border-radius:10px; box-shadow:0 0 12px #000; }
  #spectatorPickPanel .title{ font-weight:700; font-size:13px; line-height:1.1; }
  #spectatorPickPanel .sub{ font-size:12px; opacity:.9; }

  body.spectator #builder{ display:none !important; }
  body.spectator #startModal{ display:none !important; }
  body.spectator #board{ pointer-events:auto; } /* 共有用でもエリアUI(重なり)は押せるように */
  body.spectator .card{ pointer-events:none; } /* カード自体の誤操作防止 */



/* =========================================================
   UI Redesign Pack (v3.1) — 2025-12-17
   目的：見た目を「単調→締まったゲームUI」へ（機能はそのまま）
   ========================================================= */

:root{
  --bg0:#0b0d12;
  --bg1:#0f131b;
  --panel:rgba(18,22,30,.72);
  --panelSolid:rgba(18,22,30,.92);
  --panelEdge:rgba(255,255,255,.10);
  --text:#eaf0ff;
  --muted:#a8b3c9;

  --accent:#2dd4ff;        /* cyan */
  --accent2:#a78bfa;       /* violet */
  --danger:#ff4d5a;
  --warn:#ffcc66;
  --success:#22c55e;

  --shadow:0 18px 45px rgba(0,0,0,.55);
  --shadowSoft:0 8px 20px rgba(0,0,0,.35);

  --radius:18px;
  --radiusSm:12px;
  --pill:999px;

  --ui-bg:var(--panel);
  --ui-fg:var(--text);
  --zone-border:rgba(45,212,255,.42);
  --zone-fill:rgba(45,212,255,.09);
}

/* base */
html,body{
  background: radial-gradient(1200px 900px at 15% 10%, rgba(167,139,250,.14), transparent 60%),
              radial-gradient(1200px 900px at 85% 45%, rgba(45,212,255,.12), transparent 60%),
              linear-gradient(180deg, var(--bg1), var(--bg0));
  color:var(--text);
  font-family: ui-sans-serif, system-ui, -apple-system, "Segoe UI", "Noto Sans JP", "Hiragino Sans", "Yu Gothic UI", "Meiryo", sans-serif;
}

/* board overlay (上に被さらないように) */
#board{ background-color:#0b0d12; isolation:isolate; }
#board::before{
  content:"";
  position:absolute; inset:0;
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(167,139,250,.16), transparent 60%),
    radial-gradient(900px 600px at 80% 40%, rgba(45,212,255,.14), transparent 60%),
    linear-gradient(180deg, rgba(0,0,0,.15), rgba(0,0,0,.35));
  pointer-events:none;
  z-index:0;
}
#board .zone, #board .card{ z-index:1; }

/* toolbar */
#toolbar{
  border-radius:var(--radius);
  padding:10px 12px;
  background: var(--panel);
  border:1px solid var(--panelEdge);
  box-shadow: var(--shadowSoft);
  backdrop-filter: blur(12px) saturate(140%);
  gap:10px;
  font-size:12px;
}

/* common button look */
#toolbar button,
#toolbar label,
.zoneUI button,
.areaUI button,
.rageBtns button,
#viewerBtns button,
#builderFooter button,
#tokenFooter button,
#stackFooter button,
.stackCtrl button,
.revealCtrl button,
#revealFooter button,
#startBox button{
  border-radius: var(--pill);
  border:1px solid rgba(255,255,255,.14);
  background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));
  color:var(--text);
  box-shadow: 0 6px 16px rgba(0,0,0,.28);
  transition: transform .12s ease, box-shadow .12s ease, border-color .12s ease, filter .12s ease;
  letter-spacing:.01em;
}

#toolbar button,
#toolbar label{ padding:9px 18px; min-width:76px; display:inline-flex; align-items:center; justify-content:center; gap:6px; }
#toolbar button:hover,
#toolbar label:hover{ transform: translateY(-1px); filter: brightness(1.05); border-color: rgba(255,255,255,.22); }
#toolbar button:active,
#toolbar label:active{ transform: translateY(0) scale(.98); box-shadow: 0 4px 12px rgba(0,0,0,.22); }
#toolbar button:focus-visible,
#toolbar label:focus-visible{ outline:2px solid rgba(45,212,255,.55); outline-offset:2px; }

#toolbar select{
  background: rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.14);
  color:var(--text);
  border-radius: var(--pill);
  padding:6px 10px;
}
#toolbar #btnToolbarCollapse{
  min-width: 132px;
  font-weight: 700;
}
#toolbar.collapsed{
  width: auto !important;
  max-width: calc(100vw - 16px) !important;
  padding-right: 10px;
}
#toolbar.collapsed > :not(#btnToolbarCollapse){
  display:none !important;
}

/* highlight key actions */
#btnRemove{
  background: linear-gradient(180deg, rgba(255,77,90,.95), rgba(185,18,32,.92)) !important;
  border-color: rgba(255,140,150,.35) !important;
}
#btnTurnStart{
  background: linear-gradient(180deg, rgba(45,212,255,.30), rgba(32,96,255,.30)) !important;
  border-color: rgba(45,212,255,.30) !important;
}
#btnOpenSpectator{
  background: linear-gradient(180deg, rgba(34,197,94,.30), rgba(45,212,255,.22)) !important;
  border-color: rgba(34,197,94,.30) !important;
}
#btnSave{
  background: linear-gradient(180deg, rgba(255,204,102,.26), rgba(255,255,255,.06)) !important;
  border-color: rgba(255,204,102,.22) !important;
}

/* zones */
.zone{
  border:1px solid var(--zone-border) !important;
  border-style: solid !important;
  border-radius: 16px;
  background: linear-gradient(180deg, rgba(45,212,255,.10), rgba(45,212,255,.04)) !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.06);
  padding:0 !important;
  overflow: visible;
}
.zone-label{
  top:8px !important;
  left:8px !important;
  font-weight:700;
  font-size:12px;
  color: rgba(234,240,255,.95);
  background: rgba(0,0,0,.35);
  border:1px solid rgba(255,255,255,.10);
  padding:4px 8px;
  border-radius: var(--pill);
  backdrop-filter: blur(8px);
  text-shadow:none !important;
}

/* slot 1-8 labels outside the frame */
.zone.slot-zone .zone-label{
  top:-26px !important;
  left:50% !important;
  transform:translateX(-50%) !important;
}

/* zone buttons */
.zoneUI{ right:8px !important; bottom:8px !important; gap:6px !important; }

/* deckMain: ボタンが枠からはみ出さないように折り返し */
.zone[data-zone-id="deckMain"] .zoneUI{
  left:8px !important;
  right:8px !important;
  max-width:calc(100% - 16px) !important;
  flex-wrap:wrap !important;
  justify-content:flex-end !important;
  align-content:flex-end !important;
}
.zone[data-zone-id="deckMain"] .zoneUI button{
  white-space:nowrap;
  flex:0 0 auto;
}

.zoneUI button,
.areaUI button,
.rageBtns button{
  font-size:11px !important;
  padding:6px 10px !important;
  border-radius: var(--pill) !important;
  background: rgba(0,0,0,.45) !important;
  border:1px solid rgba(255,255,255,.14) !important;
  box-shadow: 0 10px 18px rgba(0,0,0,.30) !important;
}
.zoneUI button:hover,
.areaUI button:hover,
.rageBtns button:hover{ filter: brightness(1.06); transform: translateY(-1px); }

/* areaUI position tweak (outside the frame) */
.areaUI{
  top:-34px !important;
  left:auto !important;
  right:0px !important;
  transform:none !important;
  gap:6px !important;
}

/* solo: flipLayout(上側盤面)のslot1~5は手札と被るので、エリアボタンをゾーン下へ */
body.flipLayout .zone[data-zone-id="slot1"] .areaUI,
body.flipLayout .zone[data-zone-id="slot2"] .areaUI,
body.flipLayout .zone[data-zone-id="slot3"] .areaUI,
body.flipLayout .zone[data-zone-id="slot4"] .areaUI,
body.flipLayout .zone[data-zone-id="slot5"] .areaUI{
  top: calc(100% + 8px) !important;
  bottom: auto !important;
}


/* counters */
#deckCounter,#discardCounter,#monsterCounter{
  border-radius: var(--pill) !important;
  border:1px solid rgba(255,255,255,.12);
  background: rgba(0,0,0,.35) !important;
  padding:6px 10px !important;
  font-size:14px !important;
  box-shadow: 0 10px 18px rgba(0,0,0,.28);
}

/* cards */
.card{
  border-radius: 12px !important;
  box-shadow: 0 14px 28px rgba(0,0,0,.38) !important;
  outline: 1px solid rgba(255,255,255,.06);
  transition: box-shadow .14s ease, transform .14s ease, filter .14s ease;
  will-change: transform;
}
.card.active{
  box-shadow: 0 0 0 2px rgba(45,212,255,.55), 0 18px 40px rgba(0,0,0,.55) !important;
}
.card.selected{
  outline: 2px solid rgba(255, 214, 10, .90) !important;
  box-shadow: 0 0 0 3px rgba(255, 214, 10, .28), 0 18px 40px rgba(0,0,0,.55) !important;
}

/* modals: overlay */
#viewer,#builder,#token,#stack,#reveal,#startModal{
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(167,139,250,.18), transparent 60%),
    radial-gradient(900px 600px at 80% 40%, rgba(45,212,255,.14), transparent 60%),
    rgba(0,0,0,.82) !important;
}

/* modals: panels */
#viewerPanel,#builderPanel,#tokenPanel,#stackPanel,#revealPanel,#startBox{
  background: linear-gradient(180deg, rgba(18,22,30,.94), rgba(10,12,16,.90)) !important;
  border:1px solid rgba(255,255,255,.10) !important;
  border-radius: 20px !important;
  box-shadow: var(--shadow) !important;
}

/* headings */
#viewerPanel h2,
#builderPanel h2,
#tokenPanel h2,
#stackPanel h2,
#revealPanel h2,

#startBox h1{
  letter-spacing:.02em;
}

/* inputs */
#viewerSearch,
#libFilter,

#tokenCount,
#builderFooter textarea{
  border-radius: 14px !important;
  border:1px solid rgba(255,255,255,.12) !important;
  background: rgba(0,0,0,.35) !important;
  color: var(--text) !important;
  padding:10px 12px !important;
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.04);
}
#builderFooter textarea{ padding:10px 12px !important; }

/* list containers */
#viewerGrid,#libList,#deckScroll{
  border-radius: 16px !important;
  border:1px solid rgba(255,255,255,.10) !important;
  background: rgba(0,0,0,.22) !important;
}

/* rows */
.stackRow,.revealRow{
  border-radius: 16px !important;
  border:1px solid rgba(255,255,255,.10) !important;
  background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03)) !important;
}
.stackRow:hover,.revealRow:hover{ filter: brightness(1.05); }
.stackRow.selected,.revealRow.selected{
  outline:2px solid rgba(255, 214, 10, .80) !important;
}

/* thumbs */
.thumbWrap img,
.libCard img,
.deckThumb img,
.stackThumb img,
.revealThumb img,
.tokenThumb img{
  outline: 1px solid rgba(255,255,255,.08);
}

/* spectator badge */
#spectatorBadge{
  background: rgba(0,0,0,.40) !important;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: var(--pill) !important;
  box-shadow: var(--shadowSoft) !important;
  backdrop-filter: blur(10px) saturate(140%);
}

/* =========================================================
   Fullscreen Deck Builder
   - 盤面が透けて見える/モーダルが小さい問題を解消
   - 構築画面そのものを画面いっぱいに表示
   ========================================================= */

/* overlay 자체を不透明にして盤面を見せない */
#builder{
  align-items: stretch !important;
  justify-content: stretch !important;
  padding: 0 !important;
  /* 透過なし（背景が“うっすら盤面”にならない） */
  background:
    radial-gradient(900px 600px at 20% 10%, rgba(167,139,250,.18), transparent 60%),
    radial-gradient(900px 600px at 80% 40%, rgba(45,212,255,.14), transparent 60%),
    linear-gradient(180deg, #0f131b, #0b0d12) !important;
}

/* パネルをフルスクリーン化 */
#builderPanel{
  width: 100vw !important;
  height: 100vh !important;
  max-width: none !important;
  max-height: none !important;
  border-radius: 0 !important;
  border: none !important;
  box-shadow: none !important;
  margin: 0 !important;
}
#spectatorPickPanel{
  background: rgba(0,0,0,.40) !important;
  border: 1px solid rgba(255,255,255,.12);
  border-radius: 18px !important;
  box-shadow: var(--shadowSoft) !important;
  backdrop-filter: blur(10px) saturate(140%);
}

/* scrollbars (Chromium) */
*::-webkit-scrollbar{ width: 10px; height: 10px; }
*::-webkit-scrollbar-thumb{ background: rgba(255,255,255,.14); border-radius: 999px; border:2px solid rgba(0,0,0,.25); }
*::-webkit-scrollbar-track{ background: rgba(0,0,0,.18); border-radius: 999px; }



/* mobile touch targets: zoom不要で押せるサイズへ */
@media (max-width: 1024px){
  .zoneUI{
    right:6px !important;
    bottom:6px !important;
    gap:8px !important;
  }
  .areaUI{
    top:-42px !important;
    right:2px !important;
    gap:8px !important;
    flex-wrap:wrap;
    justify-content:flex-end;
    max-width:calc(100% - 8px);
  }
  .zoneUI button,
  .areaUI button,
  .rageBtns button{
    min-height:44px;
    min-width:44px;
    font-size:13px !important;
    padding:10px 12px !important;
    line-height:1.2;
  }
  .zone[data-zone-id="deckMain"] .zoneUI{
    gap:8px !important;
  }
}

@media (max-width: 768px) and (orientation: portrait){
  #previewPanel{
    flex-direction:column;
    width:min(96vw, 560px);
    height:min(calc(92vh - var(--previewSafeTop)), 920px);
  }
  #previewLeft{
    max-width:100%;
    height:auto;
    max-height:56vh;
    margin:0 auto;
  }
  #previewInfo{
    min-width:0;
    height:auto;
    flex:1 1 auto;
  }
  #previewInfo .pvRowMeta{
    flex-direction:column;
    align-items:flex-start;
    gap:8px;
  }
}
@media (prefers-reduced-motion: reduce){
  *{ transition: none !important; animation: none !important; }
}


  /* ===== Solo (一人回し) ===== */
  #soloContainer.hidden, #soloDeckModal.hidden{display:none !important;}
  #soloDeckModal{position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(0,0,0,.62);backdrop-filter:blur(6px);z-index:10000;}
  #soloDeckPanel{width:min(760px,92vw);max-height:min(82vh,760px);background:rgba(18,22,32,.96);border:1px solid rgba(90,120,180,.35);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);display:flex;flex-direction:column;overflow:hidden;}
  #soloDeckHeader{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;border-bottom:1px solid rgba(90,120,180,.25);}
  #soloDeckHeader h2{margin:0;font-size:18px;letter-spacing:.02em;}
  #btnSoloClose{background:transparent;color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:10px;padding:6px 10px;cursor:pointer;}
  #btnSoloClose:hover{background:rgba(255,255,255,.06);}
  #soloStepText{padding:10px 14px;color:#cfe6ff;font-size:13px;}
  #soloDeckSearch{margin:0 14px 10px 14px;padding:10px 12px;border-radius:12px;border:1px solid rgba(90,120,180,.25);background:rgba(0,0,0,.25);color:#fff;outline:none;}
  #soloDeckSearch:focus{border-color:rgba(120,170,255,.55);box-shadow:0 0 0 3px rgba(120,170,255,.18);}
  #soloDeckList{padding:12px 14px;overflow:auto;display:flex;flex-direction:column;gap:10px;background:rgba(0,0,0,.18);}
  .soloDeckItem{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:10px 12px;border:1px solid rgba(90,120,180,.25);border-radius:14px;background:rgba(255,255,255,.03);}
  .soloDeckMeta{min-width:0;}
  .soloDeckName{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .soloDeckInfo{opacity:.8;font-size:12px;margin-top:2px;}
  .soloDeckActions{display:flex;gap:8px;flex:0 0 auto;}
  .soloDeckActions button{background:rgba(0,0,0,.35);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:8px 12px;cursor:pointer;}
  .soloDeckActions button:hover{background:rgba(255,255,255,.06);}
  .soloDeckActions button.primary{background:rgba(0,160,255,.22);border-color:rgba(0,160,255,.45);}
  .soloDeckActions button.primary:hover{background:rgba(0,160,255,.30);}
  #soloDeckFooter{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-top:1px solid rgba(90,120,180,.25);background:rgba(10,12,18,.75);}
  #soloPickedInfo{font-size:12px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  #soloDeckFooter .btnRow{display:flex;gap:8px;}
  #soloDeckFooter button{background:rgba(0,0,0,.35);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:8px 12px;cursor:pointer;}
  #soloDeckFooter button:disabled{opacity:.45;cursor:not-allowed;}
  #soloDeckFooter button.primary{background:rgba(0,160,255,.22);border-color:rgba(0,160,255,.45);}
  #soloDeckFooter button.primary:hover{background:rgba(0,160,255,.30);}
  #soloContainer{position:fixed;inset:0;background:#000;z-index:9999;display:flex;flex-direction:column;}
  #soloTopBar{position:sticky;top:0;z-index:5;display:flex;align-items:center;justify-content:space-between;gap:10px;padding:8px 12px;background:rgba(0,0,0,.55);backdrop-filter:blur(8px);border-bottom:1px solid rgba(255,255,255,.10);}
  #soloTopBar .soloTitle{font-size:12px;opacity:.9;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  #btnSoloExit{background:rgba(255,255,255,.06);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:12px;padding:8px 12px;cursor:pointer;}
  #btnSoloExit:hover{background:rgba(255,255,255,.10);}
  #soloScroll{flex:1 1 auto;overflow-y:auto;overscroll-behavior:contain;scroll-snap-type:y mandatory;}
  #soloScroll iframe{width:100vw;height:100vh;border:0;display:block;scroll-snap-align:start;background:#000;}

  /* --- Solo: toolbar pinned + overview (2面同時表示) --- */
  #toolbar .soloOnly{display:none;}
  body.soloActive #toolbar .soloOnly{display:inline-flex;}
  body.soloActive #toolbar{right:8px;}
  body.soloActive{padding-top:0;}
  #soloTopBar{display:none;} /* ソロ中は既存ツールバーに集約 */
  #soloScroll{position:relative;}
  #soloFrames{display:flex;flex-direction:column;}
  #soloFrames iframe{width:100vw;height:100vh;border:0;display:block;scroll-snap-align:start;background:#000;}
  /* 既存の指定をsoloFramesに寄せるため、soloScroll iframeは上書きで軽く残す */
  #soloScroll iframe{width:100vw;height:100vh;border:0;display:block;background:#000;}

  /* toolbar overlap避け（ソロ中は上に余白を作る） */
  body.soloActive #soloContainer{ padding-top: var(--soloToolbarH, 56px); }
  body.soloActive #soloScroll{ height: calc(100vh - var(--soloToolbarH, 56px)); }
  body.soloActive #soloFrames iframe{ height: calc(100vh - var(--soloToolbarH, 56px)); }

  #soloContainer.overview #soloScroll{
    overflow:hidden;
    scroll-snap-type:none;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:12px;
  }
  #soloContainer.overview #soloFrames{
    position:relative;
    left:auto;
    width:auto;
    transform:scale(var(--soloOverviewScale, .5));
    transform-origin:center center;
  }


  /* ===== Deck QR ===== */
  #qrModal{position:fixed;inset:0;z-index:5350;background:rgba(0,0,0,.75);display:flex;align-items:center;justify-content:center;padding:16px;}
  #qrPanel{width:min(900px,96vw);max-height:92vh;background:#111;border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 16px 40px rgba(0,0,0,.55);overflow:hidden;display:flex;flex-direction:column;}
  .qrHeader{display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);}
  .qrHeader h2{margin:0;font-size:18px;}
  .qrHeader button{background:#444;border:1px solid #666;color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px;}
  .qrBody{padding:12px 14px;display:flex;flex-direction:column;gap:10px;align-items:center;}
  #qrCanvas{max-width:92vw;height:auto;background:#fff;border-radius:12px;image-rendering:pixelated;}
  #qrImg{max-width:92vw;height:auto;background:#fff;border-radius:12px;image-rendering:pixelated;}
  #qrText{width:100%;height:84px;resize:none;background:#000;border:1px solid rgba(255,255,255,.18);color:#fff;border-radius:12px;padding:8px 10px;font-size:12px;}
  .qrHint{font-size:12px;opacity:.8;text-align:center;}
  .qrBtns{display:flex;gap:8px;justify-content:center;flex-wrap:wrap;}
  .qrBtns button{background:#444;border:1px solid #666;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer;font-size:12px;}

/* ===== Fixed UI size + auto scale (2025-12-26) =====
   目的：端末差で盤面/ボタンがギチギチにならないよう、
   「基準解像度で固定して描画 → 画面が小さい時だけ全体を等倍縮小」します。
*/
:root{
  --base-w: 2048px;   /* 添付スクショ基準 */
  --base-h: 1015px;    /* 添付スクショ基準 */
  --ui-scale: 1;
  --stage-left: 0px;
  --stage-top: 0px;
}

/* 盤面は基準サイズで描画し、画面が小さいときだけ縮小して収める */
#stageWrap{
  position:fixed;
  inset:0;
  overflow:hidden;
  background:#181818;
  z-index:0;
}
#stage{
  position:absolute;
  left:var(--stage-left);
  top:var(--stage-top);
width:var(--base-w);
  height:var(--base-h);
  transform:scale(var(--ui-scale));
  transform-origin:0 0;
}

/* boardはstageに追従（既存の 100vw/100vh を上書き） */
#board{
  width:100% !important;
  height:100% !important;
}

/* toolbarも同じ倍率で縮小（折り返しを起こしにくい固定幅へ） */
#toolbar{
  max-width:none !important;
  width:calc(var(--base-w) - 16px);
  left:calc(var(--stage-left) + 8px) !important;
  top:calc(var(--stage-top) + 8px) !important;
  transform:scale(var(--ui-scale));
  transform-origin:0 0;
}
body.soloActive #toolbar{ right:auto !important; }


  /* ===== Shortcuts modal ===== */
  #shortcuts.hidden{display:none !important;}
  #shortcuts{position:fixed;inset:0;z-index:13000;background:rgba(0,0,0,.78);display:flex;align-items:center;justify-content:center;}
  #shortcutsPanel{width:min(720px,92vw);max-height:88vh;overflow:hidden;background:#111;border:1px solid rgba(255,255,255,.14);border-radius:16px;box-shadow:0 18px 60px rgba(0,0,0,.55);display:flex;flex-direction:column;}
  #shortcutsHeader{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px 14px;border-bottom:1px solid rgba(255,255,255,.10);}
  #shortcutsHeader h2{margin:0;font-size:18px;}
  #shortcutsHeader button{background:#444;border:1px solid #666;color:#fff;border-radius:10px;padding:6px 10px;cursor:pointer;font-size:12px;}
  #shortcutsHeader button:hover{background:#666;}
  #shortcutsBody{padding:12px 14px;overflow:auto;display:flex;flex-direction:column;gap:12px;}
  .scSection{border:1px solid rgba(255,255,255,.10);background:rgba(255,255,255,.04);border-radius:14px;padding:10px 12px;}
  .scSection h3{margin:0 0 8px;font-size:14px;opacity:.92;}
  .scTable{width:100%;border-collapse:collapse;font-size:13px;}
  .scTable td{padding:7px 8px;border-top:1px solid rgba(255,255,255,.08);vertical-align:top;}
  .scKey{white-space:nowrap;font-weight:800;}
  .scNote{opacity:.85;font-size:12px;line-height:1.35;}
  kbd{display:inline-block;padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.18);background:rgba(0,0,0,.28);box-shadow:0 1px 0 rgba(0,0,0,.35);font-family:ui-monospace, SFMono-Regular, Menlo, monospace;font-size:12px;}

  /* ===== Calculator (Play mode) ===== */
  #calcWidget.hidden{display:none !important;}
  #calcWidget{position:fixed;right:8px;top:56px;z-index:12050;width:290px;max-width:calc(100vw - 16px);background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.16);border-radius:16px;backdrop-filter:blur(6px);color:#fff;box-shadow:0 14px 40px rgba(0,0,0,.45);overflow:hidden;}
  #calcHeader{cursor:move;display:flex;align-items:center;justify-content:space-between;gap:8px;padding:10px 12px;background:rgba(255,255,255,.06);border-bottom:1px solid rgba(255,255,255,.10);user-select:none;}
  #calcHeader .title{font-weight:900;letter-spacing:.03em;}
  #calcHeader .btns{display:flex;gap:6px;align-items:center;}
  #calcHeader button{background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.16);color:#fff;border-radius:10px;padding:4px 8px;cursor:pointer;font-size:12px;}
  #calcHeader button:hover{background:rgba(255,255,255,.10);}
  #calcBody{padding:10px 12px;display:flex;flex-direction:column;gap:8px;}
  #calcInput{width:100%;padding:9px 10px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:rgba(0,0,0,.35);color:#fff;font-size:14px;outline:none;}
  #calcInput:focus{border-color:rgba(45,212,255,.75);box-shadow:0 0 0 2px rgba(45,212,255,.18);}
  #calcRow{display:flex;gap:6px;flex-wrap:wrap;}
  #calcRow button{flex:1 1 auto;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.16);color:#fff;border-radius:12px;padding:7px 10px;cursor:pointer;font-size:12px;}
  #calcRow button:hover{background:rgba(255,255,255,.10);}
  #calcResult{font-size:20px;font-weight:900;padding:10px 10px;border-radius:12px;background:rgba(0,0,0,.28);border:1px solid rgba(255,255,255,.10);min-height:46px;display:flex;align-items:center;justify-content:space-between;gap:8px;}
  #calcResult .val{word-break:break-all;}
  #calcResult .hint{opacity:.7;font-size:11px;font-weight:600;}
  #calcHistory{max-height:170px;overflow:auto;border-top:1px solid rgba(255,255,255,.10);padding-top:8px;margin-top:2px;display:flex;flex-direction:column;gap:6px;}
  .calcHistItem{cursor:pointer;padding:7px 8px;border-radius:12px;background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.08);font-size:12px;line-height:1.2;}
  .calcHistItem:hover{background:rgba(255,255,255,.08);}
  .calcErr{color:#ffb3b3;font-size:12px;}



/* ===== Play HUD (monster + total repel) ===== */
#playHud{
  position:absolute;
  right:10px;
  top:10px;
  left:auto;
  z-index:9999;
  display:flex;
  flex-direction:column;
  gap:10px;
  pointer-events:none;
  user-select:none;
  font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Hiragino Kaku Gothic ProN", "Noto Sans JP", "Yu Gothic", sans-serif;
}
.playHudPanel{
  background:rgba(0,0,0,0.72);
  border:1px solid rgba(255,255,255,0.18);
  border-radius:10px;
  box-shadow:0 6px 18px rgba(0,0,0,0.35);
  overflow:hidden;
}
#monsterHud{
  width:260px;
}
#monsterHud .mhTop{
  display:flex;
  gap:10px;
  padding:10px;
  align-items:flex-start;
}
#monsterHud .mhCard{
  width:120px;
  aspect-ratio: 63 / 88;
  border-radius:8px;
  overflow:hidden;
  background:rgba(255,255,255,0.06);
  border:1px solid rgba(255,255,255,0.14);
  flex:0 0 auto;
}
#monsterHud .mhCard img{
  width:100%;
  height:100%;
  display:block;
}
#monsterHud .mhMeta{
  flex:1 1 auto;
  min-width:0;
  color:#fff;
}
#monsterHud .mhName{
  font-weight:800;
  font-size: 16px;
  line-height:1.15;
  margin:0 0 6px 0;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#monsterHud .mhSub{
  font-size:12px;
  opacity:0.9;
  line-height:1.4;
}
#monsterHud .mhSubLine{ margin-top:6px; }
#monsterHud .mhSubLine:first-child{ margin-top:0; }
#monsterHud #mhStack{
  font-size:18px;
  font-weight:900;
  padding:4px 8px;
  letter-spacing:0.04em;
  line-height:1.15;
  display:block;
  width:100%;
  text-align:center;
}
#monsterHud .mhSub .badge{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  background:rgba(255,255,255,0.10);
  border:1px solid rgba(255,255,255,0.14);
  margin-right:6px;
  max-width:100%;
  box-sizing:border-box;
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
}
#monsterHud #mhArea{
  font-size:18px;
  font-weight:900;
  letter-spacing:0.06em;
  padding:4px 8px;
  line-height:1.15;
  display:block;
  width:100%;
  text-align:center;
}
#monsterHud .mhStats{
  display:grid;
  grid-template-columns: 1fr 1fr 1.4fr;
  gap:0;
  border-top:1px solid rgba(255,255,255,0.14);
}
#monsterHud .mhStat{
  padding:10px 10px 8px;
  border-right:1px solid rgba(255,255,255,0.14);
  color:#fff;
  text-align:center;
}
#monsterHud .mhStat:last-child{ border-right:none; }
#monsterHud .mhLabel{
  font-size:11px;
  letter-spacing:0.06em;
  opacity:0.9;
}
#monsterHud .mhValue{
  font-size:22px;
  font-weight:900;
  line-height:1.05;
  margin-top:4px;
}
#repelHud{
  width:260px;
  padding:10px 12px;
  color:#fff;
}
#repelHud .rhLabel{
  font-size:16px;
  font-weight:900;
  letter-spacing:0.06em;
  opacity:0.9;
}
#repelHud .rhRow{display:flex;align-items:baseline;justify-content:space-between;gap:10px;}
#repelHud .rhValue{
  font-size:28px;
  font-weight:900;
  line-height:1.1;
  margin-top:6px;
}
#repelHud .rhNote{
  margin-top:4px;
  font-size:11px;
  opacity:0.75;
}


  /* inline keyword icons in preview */
  .inline-icon{
    height:1.20em;
    vertical-align:-0.12em;
    margin:0 0.14em;
    image-rendering:auto;
  }
  .inline-icon-range{
    font-size:0.95em;
    font-weight:900;
    margin-left:0.05em;
    vertical-align:0.15em;
  }

  .color-icon{height:1.8em;}
  .advBadge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    background:rgba(255,255,255,0.92);
    border:1px solid rgba(0,0,0,0.18);
    border-radius:999px;
    padding:3px 10px;
    margin:0 0.12em;
    vertical-align:middle;
  }
  .advBadge .adv-icon{
    height:1.20em;
    vertical-align:0;
    margin:0;
  }



/* ===== Play mode mobile controls ===== */
:root{
  --play-toolbar-btn-min-h: 40px;
  --play-toolbar-btn-font: 13px;
}

body.playMode #toolbar button,
body.playMode #toolbar label,
body.playMode #toolbar select{
  min-height: var(--play-toolbar-btn-min-h);
  font-size: var(--play-toolbar-btn-font);
}

body.playMode #toolbar button,
body.playMode #toolbar label{
  padding: 10px 14px;
}

@media (max-width: 768px){
  body.playMode #toolbar{
    left: 0;
    right: 0;
    top: 0;
    max-width: none;
    width: 100vw;
    border-radius: 0;
    padding: max(8px, env(safe-area-inset-top)) 8px 8px;
    gap: 7px;
    justify-content: center;
  }
  body.playMode #toolbar button,
  body.playMode #toolbar label,
  body.playMode #toolbar select{
    min-height: 46px;
    font-size: 15px;
  }
  body.playMode #toolbar button,
  body.playMode #toolbar label{
    min-width: calc(50% - 8px);
    flex: 1 1 calc(50% - 8px);
    padding: 10px 12px;
    font-weight: 700;
  }
  body.playMode #toolbar label{
    justify-content: space-between;
    gap: 10px;
  }
  body.playMode #toolbar select{
    width: 100%;
    padding: 0 12px;
  }
  body.playMode #toolbar #btnOpenSpectator,
  body.playMode #toolbar #btnBackToMode,
  body.playMode #toolbar #btnTurnStart,
  body.playMode #toolbar #btnSave,
  body.playMode #toolbar #btnUndo,
  body.playMode #toolbar #btnPreview,
  body.playMode #toolbar #btnToken,
  body.playMode #toolbar #btnCounter{
    flex-basis: 100%;
    min-width: 100%;
  }
  body.playMode #toolbar.collapsed{
    width: auto !important;
    left: 6px !important;
    right: auto !important;
    top: 6px !important;
    border-radius: 14px;
    padding: max(8px, env(safe-area-inset-top)) 8px 8px;
    justify-content: flex-start;
  }
  body.playMode #toolbar.collapsed #btnToolbarCollapse{
    flex: 0 0 auto;
    min-width: 132px;
  }
}

@media (max-width: 480px){
  body.playMode #toolbar button,
  body.playMode #toolbar label,
  body.playMode #toolbar select{
    min-height: 48px;
    font-size: 14px;
  }
}

/* ===== Remake: mobile-first adjustments (UI維持) ===== */
@media (max-width: 1024px){
  :root{ --card-w: 150px; }
  #toolbar{ gap:6px; padding:6px 8px; max-width:calc(100vw - 12px); }
  #toolbar button,#toolbar label{ font-size:11px; padding:4px 7px; }
  #viewerPanel{ width:92vw; height:88vh; }
  #builderPanel{ width:96vw; height:95vh; padding:10px 12px; }
}

@media (max-width: 768px){
  :root{ --card-w: 148px; }
  html,body{ overflow:auto; }
  #toolbar{ left:6px; top:6px; right:6px; max-width:none; z-index:13000; }
  #toolbar button,#toolbar label{ min-height:32px; }
  #viewerPanel{ width:96vw; height:90vh; padding:10px 12px; }
  #viewerSearch{ width:100%; }
  #builder{ align-items:stretch; justify-content:stretch; overflow:auto; }
  #builderPanel{
    width:100vw;
    min-height:100dvh;
    height:auto;
    border-radius:0;
    padding:8px;
  }
  #builderMain{ gap:8px; overflow:auto; min-height:0; -webkit-overflow-scrolling:touch; }
  #libPane,#deckPane{ min-height:0; }
  #libList{ gap:10px; padding:8px; }
  .libCard{ width:132px; }
  .deckThumb{ width:96px; }
  #deckMgrPanel{ width:96vw; height:88vh; }

  /* 現在のデッキ欄の末尾が下部バーに隠れないよう余白を確保 */
  #deckPane{ padding-bottom:8px; }
  #deckScroll{ padding-bottom:72px; -webkit-overflow-scrolling:touch; }

  /* スマホで折りたたみ時でも展開ボタンを見失わないようにする */
  #builderFooter{ position:sticky; bottom:0; z-index:6; }
  .builderFooterHeader{ min-height:36px; }
  .builderFooterToggle{ flex:0 0 auto; }
  #countInfo{ min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
  .builderFooterSection.collapsed #countInfo{ display:none; }
  .builderFooterSection.collapsed .builderFooterHeader{ justify-content:flex-end; }
}

@media (max-width: 480px){
  :root{ --card-w: 136px; }
  #toolbar{ font-size:12px; }
  #toolbar button,#toolbar label{ font-size:11px; padding:5px 7px; }
  #startBox{ min-width:280px; width:92vw; padding:18px; }
  #builderFooter{ gap:8px; }
  .libCard{ width:min(42vw, 160px); }
  .deckThumb{ width:min(30vw, 112px); }
}

@media (max-width: 768px) and (orientation: portrait){
  #builderMain{ flex-direction:column; overflow:auto; }
  /* スマホ縦画面では「現在のデッキ」枠も十分な高さを確保する */
  #libPane{ min-height:56vh; }
  #deckPane{ min-height:52vh; }
  #deckScroll{ min-height:46vh; }
  /* スマホ縦画面ではカード一覧の縦幅を広げて見やすくする */
  #libPane{ min-height:76vh; }
  #deckPane{ min-height:28vh; }

  /* 現在のデッキ欄のカード幅を確保して視認性を上げる */
  .libCard{ width:min(34vw, 138px); }
  .deckThumb{ width:min(54vw, 124px); }
}

@media (max-width: 768px) and (orientation: landscape){
  #builderMain{
    display:grid;
    grid-template-columns:minmax(160px, 34vw) 1fr;
    grid-template-rows:auto auto auto auto 1fr;
    gap:8px 10px;
    overflow:hidden;
    min-height:0;
  }
  #mobileBuilderTabs{
    display:flex;
    grid-column:2;
    grid-row:1;
    gap:6px;
    padding:2px 0;
  }
  #mobileBuilderTabs button{
    flex:1;
    min-height:36px;
    border:1px solid rgba(255,255,255,.2);
    background:#2b2b2b;
    color:#fff;
    border-radius:10px;
    font-size:12px;
    font-weight:700;
  }
  #mobileBuilderTabs button.active{
    background:linear-gradient(180deg,#1f6a9f,#14507b);
    border-color:rgba(86,211,255,.7);
    box-shadow:0 0 0 1px rgba(86,211,255,.35) inset;
  }
  #libPane{ display:contents; }
  #libPane h3,
  #libSetSection,
  #libFilter,
  #libMetaBar{
    grid-column:1;
  }
  #libPane h3{ grid-row:1; margin:0; font-size:15px; }
  #libSetSection{ grid-row:2; margin:0; max-height:26vh; overflow:auto; }
  #libFilter{ grid-row:3; margin:0; }
  #libMetaBar{ grid-row:4; margin:0; }
  #libList,
  #deckPane{
    grid-column:2;
    grid-row:2 / span 4;
    min-height:0;
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    background:rgba(0,0,0,.22);
  }
  #libList{ padding:8px; }
  #deckPane{ padding:8px; }
  #deckPane h3{ margin-top:0; }
  #builderMain[data-mobile-view='lib'] #deckPane{ display:none; }
  #builderMain[data-mobile-view='deck'] #libList{ display:none; }
  #builderFooter textarea{ min-width:200px; }
}
